<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ© - Ø­Ù…Ù„Ø© Ø§Ù„Ù…Ø±Ø´Ø­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* (ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚) */
        body {
            background-color: #f0f2f5;
            font-family: 'Cairo', sans-serif;
        }
        .header-bg {
            background: linear-gradient(135deg, #005c97 0%, #363795 100%);
            height: 180px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            position: relative;
            margin-bottom: 80px;
        }
        .candidate-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #fff;
            position: absolute;
            bottom: -75px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .candidate-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top center; 
        }
        .main-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding: 30px;
            margin-top: -20px;
        }
        .form-control {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 1.1rem;
        }
        .btn-search {
            background-color: #363795;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            width: 100%;
            transition: 0.3s;
        }
        .btn-search:hover {
            background-color: #2a2b75;
        }
        .result-card {
            display: none;
            border: 2px solid #eef2f7;
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
            background: #fafbfc;
        }
        .voter-name-title {
            color: #363795;
            text-align: center;
            font-weight: 700;
            font-size: 1.4rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 5px;
        }
        .data-label {
            color: #666;
            font-weight: 600;
        }
        .data-value {
            color: #000;
            font-weight: 700;
            text-align: left;
        }
        .highlight-row {
            background-color: #e8f0fe;
            padding: 10px;
            border-radius: 8px;
            border-bottom: none;
            color: #1967d2;
        }
        .highlight-val {
            font-size: 1.3rem;
            color: #d93025;
        }
        .loading-spinner {
            display: none;
        }
        /* Ù„Ø¥Ø®ÙØ§Ø¡ Canvas Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        #dataCanvas {
            display: none; 
            position: absolute; 
            top: -9999px;
            left: -9999px;
        }
        .btn-download-image {
            background-color: #d93025;
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="header-bg">
        <div class="text-center text-white pt-4">
            <h2>Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª Ù…Ø¬Ù„Ø³ Ø§Ù„Ù†ÙˆØ§Ø¨</h2>
            <p class="opacity-75">Ø­Ù…Ù„Ø© Ù…ØµØ± Ø§Ù„Ù„ÙŠ Ø¬Ø§ÙŠØ©</p>
        </div>
        
        <div class="candidate-avatar">
            <img src="1000665756.jpg" alt="Ø§Ù„Ù…Ø±Ø´Ø­">
        </div>
    </div>

    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="main-card">
                    <h4 class="text-center mb-4 text-secondary">Ø§Ø³ØªØ¹Ù„Ù… Ø¹Ù† Ù„Ø¬Ù†ØªÙƒ</h4>
                    
                    <form id="electionForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø®Ø¨ (Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©)</label>
                            <input type="text" id="voterName" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø®Ø¨ Ù‡Ù†Ø§...">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)</label>
                            <input type="number" id="nationalId" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ" required>
                        </div>

                        <button type="submit" class="btn btn-primary btn-search text-white">
                            <span class="loading-spinner spinner-border spinner-border-sm ms-2"></span>
                            Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†
                        </button>
                    </form>

                    <div id="errorMsg" class="alert alert-danger mt-3 text-center" style="display:none;"></div>

                    <div id="resultArea" class="result-card">
                        <div class="voter-name-title">
                            Ø§Ù„Ù†Ø§Ø®Ø¨/ <span id="outName"></span>
                        </div>

                        <div class="data-item">
                            <span class="data-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</span>
                            <span class="data-value" id="outGov"></span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„Ù…Ø±ÙƒØ²:</span>
                            <span class="data-value" id="outSection"></span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠ:</span>
                            <span class="data-value" id="outCenter"></span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span>
                            <span class="data-value" id="outAddress"></span>
                        </div>

                        <div class="data-item highlight-row mt-3">
                            <span class="data-label" style="align-self: center;">Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©:</span>
                            <span class="data-value highlight-val" id="outSubComm"></span>
                        </div>
                        <div class="data-item highlight-row mt-2" style="background-color: #fff4e5;">
                            <span class="data-label" style="align-self: center;">Ø±Ù‚Ù…Ùƒ ÙÙŠ Ø§Ù„ÙƒØ´Ù:</span>
                            <span class="data-value highlight-val" id="outListNum" style="color: #b65c09;"></span>
                        </div>
                        
                        <button id="downloadImageBtn" class="btn btn-danger btn-download-image">
                            ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ğŸ“¸
                        </button>
                    </div>
                    
                    <div class="text-center mt-4 text-muted small">
                        Ø¨Ø±Ø¹Ø§ÙŠØ© Ø­Ù…Ù„Ø© Ø§Ù„Ù…Ø±Ø´Ø­ Ø£Ø­Ù…Ø¯ Ø¨Ù„Ø§Ù„
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <canvas id="dataCanvas"></canvas>

    <script>
        // *** Ù‡Ø§Ù…: Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Google Apps Script Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ***
        const PROXY_URL = 'https://script.google.com/macros/s/AKfycbyUgyr2VB2uLQLJE2pwzHMj8URXL6TxcXXoHGk1ww6gHAhgf_xRfHej2YBy__2VY_1f3g/exec'; 

        document.getElementById('electionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const nid = document.getElementById('nationalId').value;
            const vName = document.getElementById('voterName').value;
            const resultArea = document.getElementById('resultArea');
            const errorMsg = document.getElementById('errorMsg');
            const btn = document.querySelector('.btn-search');
            const spinner = document.querySelector('.loading-spinner');
            const downloadBtn = document.getElementById('downloadImageBtn');

            if(nid.length !== 14) {
                errorMsg.style.display = 'block';
                errorMsg.innerText = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ ØµØ­ÙŠØ­ (14 Ø±Ù‚Ù…)';
                return;
            }
            if(PROXY_URL === 'https://script.google.com/macros/s/AKfycbwRXfqS6Aeg0C310YeKYCOktykwlHFYy0zKzAEx6u-eGCzRwKSbxRjg0aS6Pc22YyvY/exec') {
                errorMsg.style.display = 'block';
                errorMsg.innerText = 'ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Google Apps Script Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ.';
                return;
            }

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            errorMsg.style.display = 'none';
            resultArea.style.display = 'none';
            downloadBtn.style.display = 'none';
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

            try {
                const formData = new URLSearchParams();
                formData.append('nid', nid);

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆØ³ÙŠØ· (Google Apps Script)
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                const data = await response.json();
                
                if(data.status === 'success') {
                    const results = data.data;
                    
                    // 1. Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    document.getElementById('outName').innerText = vName || "Ù†Ø§Ø®Ø¨";
                    document.getElementById('outGov').innerText = results.governorate;
                    document.getElementById('outSection').innerText = results.section;
                    document.getElementById('outCenter').innerText = results.center;
                    document.getElementById('outAddress').innerText = results.address;
                    document.getElementById('outSubComm').innerText = results.sub_committee;
                    document.getElementById('outListNum').innerText = results.list_number;
                    
                    resultArea.style.display = 'block';
                    downloadBtn.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„

                    // 2. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Canvas Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                    downloadBtn.onclick = () => {
                        generateAndDownloadImage({
                            name: vName || "Ù†Ø§Ø®Ø¨",
                            center: results.center,
                            committee: results.sub_committee,
                            list_number: results.list_number
                        });
                    };

                } else {
                    errorMsg.innerText = data.message || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
                    errorMsg.style.display = 'block';
                }

            } catch (err) {
                errorMsg.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆØ³ÙŠØ·. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø±Ø§Ø¨Ø· Google Apps Script.';
                errorMsg.style.display = 'block';
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                btn.innerHTML = 'Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†';
            }
        });


        // =======================================================
        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Canvas
        // =======================================================

        function generateAndDownloadImage(voterData) {
            const canvas = document.getElementById('dataCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "Anonymous";

            img.onload = function() {
                // Ø¶Ø¨Ø· Ø­Ø¬Ù… Canvas Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 1. Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
                ctx.fillStyle = '#ffffff'; 
                ctx.textAlign = 'center';
                
                const W = canvas.width;
                const H = canvas.height;
                
                // Ø§Ù„Ø®Ø·: Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ø®Ø¨
                ctx.font = 'bold ' + (W * 0.05) + 'px Cairo, sans-serif'; 
                ctx.fillText(`Ø§Ù„Ù†Ø§Ø®Ø¨: ${voterData.name}`, W / 2, H * 0.82); 

                // Ø§Ù„Ø®Ø·: Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠ
                ctx.font = 'normal ' + (W * 0.035) + 'px Cairo, sans-serif';
                ctx.fillText(`Ø§Ù„Ù…Ø±ÙƒØ²: ${voterData.center}`, W / 2, H * 0.88);
                
                // Ø§Ù„Ø®Ø·: Ø±Ù‚Ù… Ø§Ù„Ù„Ø¬Ù†Ø© (Ø®Ø· Ø¨Ø§Ø±Ø²)
                ctx.font = 'bold ' + (W * 0.05) + 'px Cairo, sans-serif'; 
                ctx.fillStyle = '#f4c718'; // Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ
                ctx.fillText(`Ø§Ù„Ù„Ø¬Ù†Ø©: ${voterData.committee}`, W * 0.25, H * 0.95);
                
                // Ø§Ù„Ø®Ø·: Ø±Ù‚Ù… ÙÙŠ Ø§Ù„ÙƒØ´ÙˆÙ (Ø®Ø· Ø¨Ø§Ø±Ø²)
                ctx.fillStyle = '#ffffff';
                ctx.fillText(`Ø±Ù‚Ù…Ùƒ: ${voterData.list_number}`, W * 0.75, H * 0.95);
                
                // 4. ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                const dataURL = canvas.toDataURL('image/jpeg', 0.9); // 0.9 Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `Ù„Ø¬Ù†ØªÙŠ_${voterData.name || 'Ù†Ø§Ø®Ø¨'}_${voterData.committee}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            img.src = '1000665756.jpg'; // Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©
            
            // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            img.onerror = function() {
                alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø´Ø­. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù 1000665756.jpg Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯.");
            };
        }
    </script>
</body>
</html>
